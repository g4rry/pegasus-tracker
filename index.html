<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pegasus Vessel Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #1565c0, #0d47a1);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .controls {
            background: #2196f3;
            padding: 15px;
            text-align: center;
            color: white;
        }
        
        .controls input, .controls button {
            margin: 5px;
            padding: 10px;
            border: none;
            border-radius: 5px;
        }
        
        .controls button {
            background: #4caf50;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        
        .controls button:hover {
            background: #45a049;
        }
        
        #map {
            height: 400px;
            width: 100%;
            margin: 20px 0;
        }
        
        .info {
            background: white;
            padding: 20px;
            margin: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .status {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>⚓ Pegasus Vessel Tracker</h1>
        <p>Dover Strait Maritime Navigation | MMSI: 232018618</p>
    </div>

    <div class="controls">
        <label>Start Time: </label>
        <input type="datetime-local" id="startTime" value="2025-06-26T03:39">
        <button onclick="startTracking()" id="trackBtn">Start Tracking</button>
    </div>

    <div id="map"></div>

    <div class="info">
        <h3>📡 Vessel Information</h3>
        <div class="status" id="status">Ready to start tracking</div>
        <div id="vesselData">
            <p><strong>Position:</strong> <span id="position">--</span></p>
            <p><strong>Speed:</strong> <span id="speed">--</span></p>
            <p><strong>Course:</strong> <span id="course">--</span></p>
            <p><strong>Time:</strong> <span id="time">--</span></p>
        </div>
    </div>

    <script>
        console.log('Loading Leaflet library...');
        
        // Multiple CDN sources for Leaflet
        const leafletSources = [
            'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js',
            'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js',
            'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js'
        ];
        
        let currentSource = 0;
        let retryCount = 0;
        const maxRetries = 10;
        
        function loadLeaflet() {
            if (currentSource >= leafletSources.length) {
                console.error('All Leaflet sources failed');
                document.getElementById('status').innerHTML = '❌ Error: Could not load map library. Please check your internet connection.';
                return;
            }
            
            const script = document.createElement('script');
            script.src = leafletSources[currentSource];
            script.onload = function() {
                console.log('Leaflet loaded from:', leafletSources[currentSource]);
                initializeMap();
            };
            script.onerror = function() {
                console.log('Failed to load from:', leafletSources[currentSource]);
                currentSource++;
                loadLeaflet();
            };
            document.head.appendChild(script);
        }
        
        // Wait for Leaflet to load
        function initializeMap() {
            if (typeof L === 'undefined') {
                retryCount++;
                if (retryCount > maxRetries) {
                    console.error('Max retries exceeded');
                    document.getElementById('status').innerHTML = '❌ Error: Map library failed to load';
                    return;
                }
                console.log(`Leaflet not loaded yet, retrying... (${retryCount}/${maxRetries})`);
                setTimeout(initializeMap, 500);
                return;
            }
            
            console.log('Leaflet loaded successfully');
            setupMap();
        }
        
        // Initialize map
        let map;
        let isTracking = false;
        let vesselMarker = null;
        let trackLine = null;
        let trackPoints = [];
        
        function setupMap() {
            try {
                // Dover Strait bounds
                const doverBounds = [[50.8, 1.0], [51.5, 1.8]];
                
                map = L.map('map').fitBounds(doverBounds);
                console.log('Map initialized');
                
                // Add base layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 18
                }).addTo(map);
                
                // Add ports
                const ports = [
                    {name: "Dover", pos: [51.1279, 1.3134]},
                    {name: "Calais", pos: [50.9513, 1.8587]},
                    {name: "Boulogne", pos: [50.7264, 1.6147]}
                ];
                
                ports.forEach(port => {
                    L.marker(port.pos).addTo(map)
                        .bindPopup(`<b>${port.name}</b><br>Port`);
                });
                
                console.log('Map setup complete');
                document.getElementById('status').innerHTML = '✅ Map loaded - Ready to track Pegasus vessel';
                
            } catch (error) {
                console.error('Map initialization error:', error);
                document.getElementById('status').innerHTML = 'Error: Could not initialize map - ' + error.message;
            }
        }
        
        function startTracking() {
            const btn = document.getElementById('trackBtn');
            const status = document.getElementById('status');
            
            if (!map) {
                alert('Map not loaded yet. Please wait a moment and try again.');
                return;
            }
            
            if (isTracking) {
                stopTracking();
                return;
            }
            
            isTracking = true;
            btn.textContent = 'Stop Tracking';
            btn.style.background = '#f44336';
            status.innerHTML = '🟢 Tracking Active - Pegasus vessel simulation';
            
            console.log('Starting vessel simulation...');
            simulateVessel();
        }
        
        function stopTracking() {
            isTracking = false;
            const btn = document.getElementById('trackBtn');
            const status = document.getElementById('status');
            
            btn.textContent = 'Start Tracking';
            btn.style.background = '#4caf50';
            status.innerHTML = '🔴 Tracking Stopped';
            
            console.log('Tracking stopped');
        }
        
        function simulateVessel() {
            if (!isTracking || !map) return;
            
            // Simulate vessel movement in Dover Strait
            const positions = [
                {lat: 51.1279, lng: 1.3134, speed: 12.5, course: 95},  // Dover
                {lat: 51.1150, lng: 1.4200, speed: 13.2, course: 98},  // Dover Strait
                {lat: 51.1000, lng: 1.5500, speed: 11.8, course: 102}, // Approaching Calais
                {lat: 50.9513, lng: 1.8587, speed: 8.0, course: 120}   // Calais
            ];
            
            let currentPos = 0;
            
            function updatePosition() {
                if (!isTracking || currentPos >= positions.length || !map) return;
                
                const pos = positions[currentPos];
                const time = new Date().toLocaleTimeString();
                
                // Update vessel marker
                if (vesselMarker) {
                    map.removeLayer(vesselMarker);
                }
                
                vesselMarker = L.circleMarker([pos.lat, pos.lng], {
                    radius: 10,
                    fillColor: '#ff4444',
                    color: '#ffffff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(map);
                
                vesselMarker.bindPopup(`
                    <b>🚢 Pegasus</b><br>
                    MMSI: 232018618<br>
                    Speed: ${pos.speed} knots<br>
                    Course: ${pos.course}°<br>
                    Time: ${time}
                `);
                
                // Update track line
                trackPoints.push([pos.lat, pos.lng]);
                if (trackLine) {
                    map.removeLayer(trackLine);
                }
                
                if (trackPoints.length > 1) {
                    trackLine = L.polyline(trackPoints, {
                        color: '#0066cc',
                        weight: 3,
                        opacity: 0.7
                    }).addTo(map);
                }
                
                // Update info panel
                document.getElementById('position').textContent = `${pos.lat.toFixed(4)}°N, ${pos.lng.toFixed(4)}°E`;
                document.getElementById('speed').textContent = `${pos.speed} knots`;
                document.getElementById('course').textContent = `${pos.course}°`;
                document.getElementById('time').textContent = time;
                
                // Pan map to vessel
                map.setView([pos.lat, pos.lng], map.getZoom());
                
                console.log(`Pegasus at position ${currentPos + 1}:`, pos);
                
                currentPos++;
                
                // Schedule next update
                if (currentPos < positions.length) {
                    setTimeout(updatePosition, 4000); // Update every 4 seconds
                } else {
                    // Restart simulation
                    setTimeout(() => {
                        currentPos = 0;
                        trackPoints = [];
                        if (trackLine) {
                            map.removeLayer(trackLine);
                            trackLine = null;
                        }
                        updatePosition();
                    }, 6000);
                }
            }
            
            updatePosition();
        }
        
        // Set default start time
        function setDefaultTime() {
            const now = new Date();
            now.setHours(3, 39, 0, 0);
            const timeInput = document.getElementById('startTime');
            if (timeInput) {
                timeInput.value = now.toISOString().slice(0, 16);
            }
        }
        
        // Start initialization when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            document.getElementById('status').innerHTML = '⏳ Loading map library...';
            setDefaultTime();
            loadLeaflet();
        });
        
        // Fallback initialization
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (!map && typeof L === 'undefined') {
                    console.log('Fallback: Trying to load Leaflet again...');
                    loadLeaflet();
                }
            }, 2000);
        });
        
        console.log('Pegasus Tracker script loaded');
    </script>
</body>
</html>
